<script>
  (function () {
    //configuration variables
    const startDate = 'September 23, 2024 00:00:00';
    const endDate = 'October 11, 2024 23:59:59';
    const maxSubmissionsPerWeek = 10;
    const weeksToRun = 3;
    const values = [
      '5940703568127324',
      '8116638813511933',
      '5138697780333294',
      '0467666175178326',
      '9998528253204692',
      '0310203365805716',
      '4726789306531354',
      '9155338943976249',
      '2324158172856400',
      '6112902922975441',
    ];

    //set when voting form should show
    const inSchedule = setSchedule(startDate, endDate);

    //save any search parameters, then remove search or hash from url
    const params = new URLSearchParams(document.location.search);
    if (location.search || location.hash) {
      history.replaceState('', document.title, location.pathname);
    }

    //remove margin from html block holding this script
    const scriptTag = document.scripts[document.scripts.length - 1];
    scriptTag.parentNode.style.marginTop = '0';

    //get vote buttons
    const button1 = document.querySelector('#intro h3 > a');
    const button2 = document.querySelector('#vote-now a');
    if (button1) button1.addEventListener('click', replaceUrl);
    if (button2) button2.addEventListener('click', replaceUrl);

    ///////////////////////////////////////
    //refactor code below
    ///////////////////////////////////////

    //if this is a thank-you response, track that a new vote was cast
    if (params.get('response') === 'thank-you') {
      if (timesVoted < 5) timesVoted += 1;
      const value = values[timesVoted];
      document.cookie =
        `${votingRound}=${value}; ` +
        `expires=${votingRoundExpires}; ` +
        `path=${location.pathname}`;
    }

    //if this is a thank-you response or votes were maxed out, add a thank you title
    if (params.get('response') === 'thank-you' || timesVoted >= allowedVotes) {
      let intro = document.querySelector('#intro p');
      if (intro) {
        const h2 = document.createElement('h2');
        h2.setAttribute('style', 'color: #8b0b04; text-align: center;');
        h2.innerHTML =
          "<strong>Thank you for voting in KLRN's City Showdown!</strong>";
        intro.parentElement.prepend(h2);
      }
    }

    //if votes were maxed out or voting is over, remove voting buttons and form
    if (timesVoted >= allowedVotes || !votingRound || !inSchedule) {
      const voteForm = document.querySelector('#vote');
      if (voteForm) voteForm.parentElement.remove();
      if (button1) button1.parentElement.remove();
      const button2Block = document.querySelector('#vote-now');
      if (button2Block) button2Block.parentElement.remove();
      const biosLink = document.querySelector('#bios a'); //also, shorten bios button
      if (biosLink) biosLink.innerHTML = 'See Bios &gt;';
    }

    function replaceUrl() {
      setTimeout(
        () => history.replaceState('', document.title, location.pathname),
        1
      );
    }

    function getCookie(name) {
      const cookies = document.cookie.split(';');
      return cookies.find((val) => val.trim().startsWith(`${name}=`));
    }

    function getDateTimeGMT(dateTimeString = '') {
      let date = dateTimeString ? new Date(dateTimeString) : new Date();
      date.setUTCMinutes(date.getUTCMinutes() - date.getTimezoneOffset());
      return date;
    }

    function setSchedule(startString, endString) {
      /*
        @startString: in format: 'October 3, 1975 13:22:00'
        @endString: in format: 'October 3, 1975 13:22:00'
        @return true or false: whether current date and time is between startString and endString
      */
      const now = getDateTimeGMT();
      const start = getDateTimeGMT(startString);
      const end = getDateTimeGMT(endString);
      return now >= start && now <= end;
    }
  })();
</script>
